<head>
  <link rel="stylesheet" href="/assets/styles/result.css">
</head>
<h1>æ¡ç‚¹çµæœ</h1>
<!-- æ¡ç‚¹çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
<div id="resultDisplay"></div>
<div id="resultIcon" class="result-icon"></div>
<button onclick="onRestart()">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã™ã‚‹</button>

<script>
  // localStorageã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  const data = localStorage.getItem("aiueoData");
  if (!data) {
    document.getElementById("resultDisplay").innerHTML = "<p>ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</p>";
  }

  const formData = JSON.parse(data);
  const topic = formData.topic;
  const topicYomi = formData.topicYomi;
  const inputs = formData.inputs;

  // ãŠé¡Œã®è¡¨ç¤º
  const resultDiv = document.getElementById("resultDisplay");
  resultDiv.innerHTML = "<p>ãŠé¡Œ: " + topic + "</p>";

  // ä½œæˆã—ãŸæ–‡ç« ã®è¡¨ç¤ºï¼ˆä¾‹ã¨ã—ã¦ã€å„æ–‡å­—ã¨å…¥åŠ›å†…å®¹ã‚’è¡¨ç¤ºï¼‰
  resultDiv.innerHTML += "<h2>ã‚ãªãŸã®ä½œæ–‡</h2>";
  for (let i = 0; i < topicYomi.length; i++) {
    resultDiv.innerHTML += "<p>" + topicYomi[i] + "ï¼š " + inputs[i] + "</p>";
  }
  displayResult();

  // ã€Œã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã™ã‚‹ã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç†
  function onRestart() {
    localStorage.removeItem("aiueoData");
    window.location.href = "input"
  }

  async function displayResult() {
    const fetchedData = await fetchScore(topic, inputs);
    const score = await fetchedData.json();
    if (score === null) {
      console.log("Score is null, unable to display result.");
      return;
    }

    const keys = Object.keys(score);
    const values = Object.values(score);

    // çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã«çµæœã‚’è¡¨ç¤º
    const resultIconDiv = document.getElementById("resultIcon");
    for (let i = 0; i < keys.length; i++) {
      // ç‚¹æ•°ã®å¹³å‡å€¤ã‚’è¨ˆç®—
      const averageValueFn = (value) => value.reduce((acc, current) => acc + current, 0) / value.length;
      const averageValue = averageValueFn(JSON.parse(values[i]));

      // ç‚¹æ•°ã®è¡¨ç¤º
      resultDiv.innerHTML += keys[i] + "ã®çµæœï¼š";
      resultDiv.innerHTML += Math.floor(averageValue) + "ç‚¹ã€€";

      // ç‚¹æ•°ã«å¿œã˜ãŸã‚¢ã‚¤ã‚³ãƒ³ã®è¡¨ç¤º
      if (averageValue >= 70) {
        resultIconDiv.innerHTML += "ğŸ˜Š";
      } else if (averageValue <= 40) {
        resultIconDiv.innerHTML += "ğŸ¤–";
      } else {
        resultIconDiv.innerHTML += "ğŸ˜";
      }
    }
  }

  async function fetchScore(topic, inputs) {
    const bodyData = {
      topic: topic,
      text: inputs
    }

    try {
      const response = await fetch('/api/v1/score', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(bodyData)
      });
      return response;
      if (!response) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }
    } catch (e) {
      console.error("Failed to fetch data", e);
    }
  }
</script>

<%- contentFor("css") %>
  <link rel="stylesheet" href="/styles/result.css">
